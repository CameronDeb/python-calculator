<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Encrypted Password Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for disabled button */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Style for password visibility toggle */
        .password-field {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280; /* gray-500 */
            z-index: 10; /* Ensure icon is clickable */
        }
        .toggle-password:hover {
            color: #1f2937; /* gray-800 */
        }
        /* Style for copy feedback */
        .copy-feedback {
            position: absolute;
            /* Adjusted position relative to copy button */
            right: 40px; /* Position left of the visibility toggle */
            top: 50%;
            transform: translateY(-50%);
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Don't interfere with clicks */
        }
        .copy-feedback.show {
            opacity: 1;
        }
        /* Password Strength Indicator */
        .strength-indicator {
            height: 5px;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
            margin-top: 4px;
        }
        .strength-weak { background-color: #ef4444; width: 25%; } /* red-500 */
        .strength-medium { background-color: #f59e0b; width: 50%; } /* amber-500 */
        .strength-strong { background-color: #22c55e; width: 75%; } /* green-500 */
        .strength-very-strong { background-color: #10b981; width: 100%; } /* emerald-500 */

        /* Lock Screen Overlay */
        #lockScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-200 via-blue-200 to-purple-200 min-h-screen p-4 md:p-8">

    <div id="lockScreen">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <i class="fas fa-lock text-4xl text-purple-600 mb-4"></i>
            <h2 id="lockScreenTitle" class="text-2xl font-bold text-gray-800 mb-4">Vault Locked</h2>
            <p id="lockScreenMessage" class="text-gray-600 mb-6">Enter your Master Password to unlock.</p>
            <form id="masterPasswordForm">
                 <div class="password-field mb-4">
                     <label for="masterPasswordInput" class="sr-only">Master Password</label>
                    <input type="password" id="masterPasswordInput" placeholder="Master Password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent pr-10">
                     <i class="fas fa-eye toggle-password" data-target="masterPasswordInput"></i>
                 </div>
                 <div class="password-field mb-4 hidden" id="confirmMasterPasswordContainer">
                     <label for="confirmMasterPasswordInput" class="sr-only">Confirm Master Password</label>
                    <input type="password" id="confirmMasterPasswordInput" placeholder="Confirm Master Password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent pr-10">
                     <i class="fas fa-eye toggle-password" data-target="confirmMasterPasswordInput"></i>
                 </div>
                 <p id="masterPasswordError" class="text-red-500 text-sm mb-4 h-4"></p>
                <button type="submit" id="masterPasswordSubmitBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition duration-200 ease-in-out">
                    Unlock
                </button>
            </form>
             <button id="resetVaultBtn" class="mt-4 text-xs text-gray-500 hover:text-red-600">Reset Vault (Deletes ALL Data)</button>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 hidden">

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Password Manager</h1>
             <button id="lockVaultBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                <i class="fas fa-lock mr-1"></i> Lock Vault
            </button>
        </div>


        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Entry</h2>
            <form id="addPasswordForm" class="space-y-4">
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-600 mb-1">Website/App:</label>
                    <input type="text" id="website" placeholder="e.g., google.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username/Email:</label>
                    <input type="text" id="username" placeholder="e.g., user@example.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Password:</label>
                    <div class="password-field">
                        <input type="password" id="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent pr-10">
                        <i class="fas fa-eye toggle-password" data-target="password"></i>
                    </div>
                    <div id="passwordStrength" class="mt-1">
                        <div class="strength-indicator"></div>
                        <span id="strengthText" class="text-xs text-gray-500"></span>
                    </div>
                </div>
                 <div class="pt-2">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Generate Password:</label>
                    <div class="flex flex-col sm:flex-row items-center gap-3">
                        <input type="number" id="passwordLength" value="16" min="8" max="64" class="p-2 border border-gray-300 rounded-lg w-20 text-center">
                        <button type="button" id="generatePasswordBtn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow transition duration-200 text-sm">Generate & Fill</button>
                    </div>
                     <div class="mt-2 space-x-4 text-sm text-gray-600">
                        <label><input type="checkbox" id="includeUppercase" checked> Uppercase</label>
                        <label><input type="checkbox" id="includeNumbers" checked> Numbers</label>
                        <label><input type="checkbox" id="includeSymbols" checked> Symbols</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition duration-200 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Add Entry
                </button>
            </form>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Saved Entries</h2>
             <div class="mb-4">
                <label for="searchInput" class="sr-only">Search Entries</label>
                <input type="search" id="searchInput" placeholder="Search by website or username..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

             <p class="text-sm text-orange-600 mb-4 font-medium"><i class="fas fa-exclamation-triangle mr-1"></i>Warning: Client-side encryption is for demonstration. Use dedicated password managers for real security.</p>
            <div id="passwordList" class="space-y-3">
                <p id="noEntriesMessage" class="text-gray-500 italic">No entries saved yet.</p>
                 <p id="noSearchResultsMessage" class="text-gray-500 italic hidden">No entries match your search.</p>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const lockScreen = document.getElementById('lockScreen');
        const appContainer = document.getElementById('appContainer');
        const masterPasswordForm = document.getElementById('masterPasswordForm');
        const masterPasswordInput = document.getElementById('masterPasswordInput');
        const confirmMasterPasswordContainer = document.getElementById('confirmMasterPasswordContainer');
        const confirmMasterPasswordInput = document.getElementById('confirmMasterPasswordInput');
        const masterPasswordError = document.getElementById('masterPasswordError');
        const masterPasswordSubmitBtn = document.getElementById('masterPasswordSubmitBtn');
        const lockScreenTitle = document.getElementById('lockScreenTitle');
        const lockScreenMessage = document.getElementById('lockScreenMessage');
        const resetVaultBtn = document.getElementById('resetVaultBtn');
        const lockVaultBtn = document.getElementById('lockVaultBtn');

        const addPasswordForm = document.getElementById('addPasswordForm');
        const websiteInput = document.getElementById('website');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const passwordListDiv = document.getElementById('passwordList');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const noSearchResultsMessage = document.getElementById('noSearchResultsMessage');
        const searchInput = document.getElementById('searchInput');

        // Password Generator Elements
        const generatePasswordBtn = document.getElementById('generatePasswordBtn');
        const passwordLengthInput = document.getElementById('passwordLength');
        const includeUppercaseCheckbox = document.getElementById('includeUppercase');
        const includeNumbersCheckbox = document.getElementById('includeNumbers');
        const includeSymbolsCheckbox = document.getElementById('includeSymbols');

        // Password Strength Elements
        const passwordStrengthDiv = document.getElementById('passwordStrength');
        const strengthIndicator = passwordStrengthDiv.querySelector('.strength-indicator');
        const strengthText = document.getElementById('strengthText');

        // --- Constants ---
        const HASH_KEY = 'simplePasswordManagerHash'; // Key for storing the master password hash
        const DATA_KEY = 'simplePasswordManagerData'; // Key for storing encrypted password entries
        const SALT_KEY = 'simplePasswordManagerSalt'; // Key for storing the salt

        // --- State ---
        let currentMasterKey = null; // Holds the derived key during the session
        let passwordEntries = []; // Holds the decrypted password entries during the session

        // --- Utility Functions ---

        /**
         * Basic HTML escaping to prevent XSS.
         * @param {string} str - The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        /**
         * Generates a random salt.
         * @returns {string} A random salt string.
         */
        function generateSalt() {
            return CryptoJS.lib.WordArray.random(128 / 8).toString(CryptoJS.enc.Hex);
        }

        /**
         * Derives an encryption key from the master password and salt using PBKDF2.
         * @param {string} masterPassword - The user's master password.
         * @param {string} salt - The salt string.
         * @returns {Object} The derived key (CryptoJS WordArray).
         */
        function deriveKey(masterPassword, salt) {
            // Use PBKDF2 for key derivation - more secure against brute-force
            // Parameters: password, salt, { keySize: bits/32, iterations: number }
            return CryptoJS.PBKDF2(masterPassword, salt, {
                keySize: 256 / 32, // 256-bit key
                iterations: 10000 // Adjust iterations based on performance needs (higher is better)
            });
        }

        /**
         * Hashes the master password using the derived key (HMAC-SHA256).
         * This hash is stored to verify the master password on subsequent logins.
         * @param {string} masterPassword - The user's master password.
         * @param {Object} key - The derived key (CryptoJS WordArray).
         * @returns {string} The HMAC hash string.
         */
        function hashMasterPassword(masterPassword, key) {
            return CryptoJS.HmacSHA256(masterPassword, key.toString()).toString();
        }

        /**
         * Encrypts data using AES with the derived key.
         * @param {string} data - The plaintext data (JSON stringified array).
         * @param {Object} key - The derived key (CryptoJS WordArray).
         * @returns {string} The encrypted data (ciphertext string).
         */
        function encryptData(data, key) {
            return CryptoJS.AES.encrypt(data, key.toString()).toString();
        }

        /**
         * Decrypts data using AES with the derived key.
         * @param {string} ciphertext - The encrypted data string.
         * @param {Object} key - The derived key (CryptoJS WordArray).
         * @returns {string|null} The decrypted plaintext data, or null on error.
         */
        function decryptData(ciphertext, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, key.toString());
                const decryptedData = bytes.toString(CryptoJS.enc.Utf8);
                return decryptedData;
            } catch (e) {
                console.error("Decryption failed:", e);
                return null; // Indicate decryption failure
            }
        }

        // --- Password Strength Calculation ---
        function calculatePasswordStrength(password) {
            let score = 0;
            if (!password) return { score: 0, text: '' };

            // Criteria
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[A-Z]/.test(password)) score++; // Uppercase
            if (/[a-z]/.test(password)) score++; // Lowercase
            if (/[0-9]/.test(password)) score++; // Numbers
            if (/[^A-Za-z0-9]/.test(password)) score++; // Symbols

            // Determine strength text and class
            let text = '';
            let strengthClass = '';
            if (score <= 2) {
                text = 'Weak';
                strengthClass = 'strength-weak';
            } else if (score <= 4) {
                text = 'Medium';
                strengthClass = 'strength-medium';
            } else if (score === 5) {
                text = 'Strong';
                strengthClass = 'strength-strong';
            } else { // score >= 6
                text = 'Very Strong';
                strengthClass = 'strength-very-strong';
            }
            return { score, text, strengthClass };
        }

        function updatePasswordStrengthIndicator(password) {
            const { text, strengthClass } = calculatePasswordStrength(password);
            strengthText.textContent = text;
            strengthIndicator.className = `strength-indicator ${strengthClass}`; // Reset and apply new class
        }


        // --- Core Application Logic ---

        /**
         * Loads and decrypts password entries using the current master key.
         * Stores the decrypted entries in the `passwordEntries` state variable.
         * @returns {boolean} True if loading and decryption were successful, false otherwise.
         */
        function loadAndDecryptEntries() {
            if (!currentMasterKey) return false; // Need the key first

            const encryptedData = localStorage.getItem(DATA_KEY);
            if (!encryptedData) {
                passwordEntries = []; // No data saved yet
                return true;
            }

            const decryptedJson = decryptData(encryptedData, currentMasterKey);
            if (decryptedJson === null) {
                // Decryption failed - likely wrong master password used for the key derivation
                return false;
            }

            try {
                passwordEntries = JSON.parse(decryptedJson);
                return true;
            } catch (e) {
                console.error("Error parsing decrypted data:", e);
                passwordEntries = []; // Reset on error
                return false;
            }
        }

        /**
         * Encrypts and saves the current `passwordEntries` state to localStorage.
         */
        function encryptAndSaveEntries() {
            if (!currentMasterKey) {
                console.error("Cannot save entries without a master key.");
                return;
            }
            try {
                const dataToEncrypt = JSON.stringify(passwordEntries);
                const encryptedData = encryptData(dataToEncrypt, currentMasterKey);
                localStorage.setItem(DATA_KEY, encryptedData);
            } catch (e) {
                console.error("Error encrypting or saving data:", e);
                alert("Could not save password data!");
            }
        }

        /**
         * Renders the password entries (from `passwordEntries` state) in the UI, applying search filter.
         */
        function renderPasswords() {
            passwordListDiv.innerHTML = ''; // Clear current list
            const searchTerm = searchInput.value.toLowerCase().trim();
            let hasVisibleEntries = false;

            // Filter entries based on search term
            const filteredEntries = passwordEntries.filter(entry =>
                entry.website.toLowerCase().includes(searchTerm) ||
                entry.username.toLowerCase().includes(searchTerm)
            );

            if (passwordEntries.length === 0) {
                noEntriesMessage.classList.remove('hidden');
                noSearchResultsMessage.classList.add('hidden');
            } else if (filteredEntries.length === 0 && searchTerm) {
                 noEntriesMessage.classList.add('hidden');
                 noSearchResultsMessage.classList.remove('hidden');
            }
             else {
                 noEntriesMessage.classList.add('hidden');
                 noSearchResultsMessage.classList.add('hidden');

                filteredEntries.forEach((entry, originalIndex) => {
                    // Find the original index in the unfiltered list to ensure correct deletion/updates
                     const indexInFullList = passwordEntries.findIndex(p => p.id === entry.id); // Use ID for reliability

                    hasVisibleEntries = true;
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'p-4 bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-3 entry-item';
                    entryDiv.innerHTML = `
                        <div class="flex-grow overflow-hidden"> <p class="font-semibold text-lg text-gray-800 truncate">${escapeHtml(entry.website)}</p> <p class="text-sm text-gray-600 truncate">${escapeHtml(entry.username)}</p> <div class="password-field mt-1 relative">
                                <input type="password" value="${escapeHtml(entry.password)}" readonly class="password-display text-sm text-gray-600 bg-gray-100 border border-transparent rounded px-2 py-1 w-full pr-16"> <button class="copy-password-btn absolute right-8 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600 p-1" data-index="${indexInFullList}" title="Copy Password">
                                    <i class="fas fa-copy"></i>
                                </button>
                                 <i class="fas fa-eye toggle-password" data-target-index="${indexInFullList}"></i>
                                <span class="copy-feedback">Copied!</span>
                            </div>
                        </div>
                        <button class="delete-entry-btn text-red-500 hover:text-red-700 font-medium text-sm self-start md:self-center flex-shrink-0" data-index="${indexInFullList}" title="Delete Entry">
                           <i class="fas fa-trash-alt mr-1"></i> Delete
                        </button>
                    `;
                    passwordListDiv.appendChild(entryDiv);
                });
            }
        }

        /**
         * Handles adding a new password entry.
         */
        function handleAddPassword(event) {
            event.preventDefault();
            const newEntry = {
                id: Date.now().toString(), // Simple unique ID
                website: websiteInput.value.trim(),
                username: usernameInput.value.trim(),
                password: passwordInput.value // Store the actual password temporarily
            };

            if (!newEntry.website || !newEntry.username || !newEntry.password) {
                alert("Please fill in all fields.");
                return;
            }

            passwordEntries.push(newEntry); // Add to the state array
            encryptAndSaveEntries(); // Encrypt and save the updated array
            renderPasswords(); // Re-render the list

            // Clear the form
            addPasswordForm.reset();
            updatePasswordStrengthIndicator(''); // Reset strength indicator
        }

        /**
         * Handles deleting a password entry.
         */
        function handleDeletePassword(index) {
            if (confirm(`Are you sure you want to delete the entry for "${passwordEntries[index].website}"?`)) {
                passwordEntries.splice(index, 1); // Remove from state array
                encryptAndSaveEntries(); // Encrypt and save the updated array
                renderPasswords(); // Re-render the list
            }
        }

        /**
         * Handles copying a password to the clipboard.
         */
        function handleCopyPassword(index, buttonElement) {
            const passwordToCopy = passwordEntries[index].password;
            navigator.clipboard.writeText(passwordToCopy).then(() => {
                // Show feedback
                const feedbackSpan = buttonElement.closest('.password-field').querySelector('.copy-feedback');
                feedbackSpan.classList.add('show');
                setTimeout(() => {
                    feedbackSpan.classList.remove('show');
                }, 1500); // Hide after 1.5 seconds
            }).catch(err => {
                console.error('Failed to copy password: ', err);
                alert('Failed to copy password.');
            });
        }

        /**
         * Toggles password visibility in an input field.
         */
        function togglePasswordVisibility(iconElement) {
            const targetId = iconElement.getAttribute('data-target');
            const targetIndex = iconElement.getAttribute('data-target-index');
            let targetInput;

            if (targetId) {
                // For master password or add form password
                targetInput = document.getElementById(targetId);
            } else if (targetIndex !== null) {
                // For password display in the list
                 // Find the correct input within the list based on index
                 const entryDivs = passwordListDiv.querySelectorAll('.entry-item');
                 // Need to find the div corresponding to the original index before filtering
                 const targetDiv = Array.from(entryDivs).find(div => div.querySelector('.delete-entry-btn').getAttribute('data-index') === targetIndex);
                 if(targetDiv) {
                    targetInput = targetDiv.querySelector('.password-display');
                 }
            }


            if (!targetInput) return;

            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                targetInput.type = 'password';
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }

        // --- Password Generation ---
        function generatePassword() {
            const length = parseInt(passwordLengthInput.value);
            const includeUpper = includeUppercaseCheckbox.checked;
            const includeNums = includeNumbersCheckbox.checked;
            const includeSyms = includeSymbolsCheckbox.checked;

            const lowerChars = 'abcdefghijklmnopqrstuvwxyz';
            const upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numChars = '0123456789';
            const symbolChars = '!@#$%^&*()_+~`|}{[]:;?><,./-=';

            let availableChars = lowerChars;
            if (includeUpper) availableChars += upperChars;
            if (includeNums) availableChars += numChars;
            if (includeSyms) availableChars += symbolChars;

            if (availableChars.length === 0) {
                alert("Please select at least one character type for password generation.");
                return ''; // Return empty if no types selected
            }

            let generatedPassword = '';
            // Ensure at least one of each selected type if possible and length allows
            let guaranteedChars = '';
            if (includeUpper && length >= 1) guaranteedChars += upperChars[Math.floor(Math.random() * upperChars.length)];
            if (includeNums && length >= guaranteedChars.length + 1) guaranteedChars += numChars[Math.floor(Math.random() * numChars.length)];
            if (includeSyms && length >= guaranteedChars.length + 1) guaranteedChars += symbolChars[Math.floor(Math.random() * symbolChars.length)];
             // Ensure at least one lowercase if others aren't selected or length allows
            if (guaranteedChars.length < length) guaranteedChars += lowerChars[Math.floor(Math.random() * lowerChars.length)];


            // Fill the rest of the password length
            for (let i = guaranteedChars.length; i < length; i++) {
                 generatedPassword += availableChars[Math.floor(Math.random() * availableChars.length)];
            }

             // Add guaranteed characters and shuffle
            generatedPassword += guaranteedChars;
            generatedPassword = generatedPassword.split('').sort(() => 0.5 - Math.random()).join(''); // Shuffle

            return generatedPassword.slice(0, length); // Ensure correct length if guaranteed chars made it slightly longer
        }


        // --- Lock/Unlock Logic ---

        function unlockVault(key) {
            currentMasterKey = key;
            if (loadAndDecryptEntries()) {
                lockScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                masterPasswordInput.value = ''; // Clear password field
                masterPasswordError.textContent = ''; // Clear errors
                renderPasswords(); // Initial render
            } else {
                // Decryption failed - likely wrong password
                currentMasterKey = null; // Reset key
                masterPasswordError.textContent = 'Incorrect Master Password or corrupted data.';
                masterPasswordInput.value = '';
            }
        }

        function lockVault() {
            currentMasterKey = null; // Clear the key from memory
            passwordEntries = []; // Clear decrypted data from memory
            appContainer.classList.add('hidden');
            lockScreen.classList.remove('hidden');
            // Reset lock screen state (in case it was in setup mode)
            confirmMasterPasswordContainer.classList.add('hidden');
             masterPasswordSubmitBtn.textContent = 'Unlock';
             lockScreenTitle.textContent = 'Vault Locked';
             lockScreenMessage.textContent = 'Enter your Master Password to unlock.';
             masterPasswordError.textContent = '';
        }

        function handleMasterPasswordSubmit(event) {
            event.preventDefault();
            masterPasswordError.textContent = ''; // Clear previous errors
            const enteredPassword = masterPasswordInput.value;
            const storedHash = localStorage.getItem(HASH_KEY);
            const salt = localStorage.getItem(SALT_KEY);

            if (!enteredPassword) {
                 masterPasswordError.textContent = 'Please enter a password.';
                 return;
            }

            if (storedHash && salt) {
                // --- Unlock Attempt ---
                const key = deriveKey(enteredPassword, salt);
                const currentHash = hashMasterPassword(enteredPassword, key);

                if (currentHash === storedHash) {
                    // Password is correct, unlock
                    unlockVault(key);
                } else {
                    // Incorrect password
                    masterPasswordError.textContent = 'Incorrect Master Password.';
                    masterPasswordInput.value = ''; // Clear input
                }
            } else {
                // --- First Time Setup ---
                const confirmPassword = confirmMasterPasswordInput.value;
                if (!confirmPassword) {
                    masterPasswordError.textContent = 'Please confirm your Master Password.';
                    return;
                }
                if (enteredPassword !== confirmPassword) {
                    masterPasswordError.textContent = 'Passwords do not match.';
                    return;
                }
                if (calculatePasswordStrength(enteredPassword).score < 3) { // Require at least medium strength
                     masterPasswordError.textContent = 'Master Password is too weak. Try adding uppercase, numbers, or symbols.';
                     return;
                }

                // Set up new vault
                const newSalt = generateSalt();
                const newKey = deriveKey(enteredPassword, newSalt);
                const newHash = hashMasterPassword(enteredPassword, newKey);

                localStorage.setItem(SALT_KEY, newSalt);
                localStorage.setItem(HASH_KEY, newHash);
                localStorage.setItem(DATA_KEY, ''); // Initialize empty data

                // Unlock with the new key
                unlockVault(newKey);
                 // Hide confirm field after setup
                 confirmMasterPasswordContainer.classList.add('hidden');
                 masterPasswordSubmitBtn.textContent = 'Unlock';
                 lockScreenTitle.textContent = 'Vault Locked';
                 lockScreenMessage.textContent = 'Enter your Master Password to unlock.';
            }
        }

        function handleResetVault() {
            if (confirm("ARE YOU SURE? This will delete your master password hash and ALL encrypted password entries permanently. There is NO undo.")) {
                 if (confirm("SECOND CONFIRMATION: Delete everything?")) {
                    localStorage.removeItem(HASH_KEY);
                    localStorage.removeItem(DATA_KEY);
                    localStorage.removeItem(SALT_KEY);
                    currentMasterKey = null;
                    passwordEntries = [];
                    // Reset lock screen to setup mode
                    lockScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    confirmMasterPasswordContainer.classList.remove('hidden');
                    masterPasswordSubmitBtn.textContent = 'Set Master Password';
                    lockScreenTitle.textContent = 'Setup Master Password';
                    lockScreenMessage.textContent = 'Choose a strong Master Password to secure your vault.';
                    masterPasswordInput.value = '';
                    confirmMasterPasswordInput.value = '';
                    masterPasswordError.textContent = '';
                    alert("Vault has been reset.");
                 }
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if vault is set up
            if (!localStorage.getItem(HASH_KEY) || !localStorage.getItem(SALT_KEY)) {
                // Show setup mode
                confirmMasterPasswordContainer.classList.remove('hidden');
                masterPasswordSubmitBtn.textContent = 'Set Master Password';
                lockScreenTitle.textContent = 'Setup Master Password';
                lockScreenMessage.textContent = 'Choose a strong Master Password to secure your vault.';
            } else {
                 // Vault exists, prompt for unlock
                confirmMasterPasswordContainer.classList.add('hidden');
                masterPasswordSubmitBtn.textContent = 'Unlock';
                lockScreenTitle.textContent = 'Vault Locked';
                lockScreenMessage.textContent = 'Enter your Master Password to unlock.';
            }

            // Master Password Form Submission
            masterPasswordForm.addEventListener('submit', handleMasterPasswordSubmit);

            // Reset Vault Button
            resetVaultBtn.addEventListener('click', handleResetVault);

            // Lock Vault Button
            lockVaultBtn.addEventListener('click', lockVault);

            // Add Password Form Submission
            addPasswordForm.addEventListener('submit', handleAddPassword);

            // Password List Event Delegation (for delete, copy, toggle visibility)
            passwordListDiv.addEventListener('click', (event) => {
                const deleteButton = event.target.closest('.delete-entry-btn');
                const copyButton = event.target.closest('.copy-password-btn');
                const toggleIcon = event.target.closest('.toggle-password');

                if (deleteButton) {
                    const index = parseInt(deleteButton.getAttribute('data-index'));
                    handleDeletePassword(index);
                } else if (copyButton) {
                    const index = parseInt(copyButton.getAttribute('data-index'));
                    handleCopyPassword(index, copyButton);
                } else if (toggleIcon) {
                    togglePasswordVisibility(toggleIcon);
                }
            });

            // General Toggle Password Visibility (for master password fields, add form)
             document.body.addEventListener('click', (event) => {
                const toggleIcon = event.target.closest('.toggle-password');
                // Ensure it's not one handled by the passwordListDiv delegation
                if (toggleIcon && !toggleIcon.hasAttribute('data-target-index')) {
                     togglePasswordVisibility(toggleIcon);
                }
            });


            // Search Input Listener
            searchInput.addEventListener('input', renderPasswords);

            // Password Generator Button
            generatePasswordBtn.addEventListener('click', () => {
                const generated = generatePassword();
                if(generated) {
                    passwordInput.value = generated;
                    // Trigger input event to update strength meter
                    passwordInput.dispatchEvent(new Event('input'));
                }
            });

             // Password Strength Listener
            passwordInput.addEventListener('input', (event) => {
                updatePasswordStrengthIndicator(event.target.value);
            });

        });

    </script>

</body>
</html>
